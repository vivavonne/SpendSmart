SET VAR_START_DATE ='01-JAN-2019';
SET VAR_END_DATE = '30-SEP-2021';

(SELECT
 MONTHNAME(E.EXP_DATE) AS MONTH
, YEAR(E.EXP_DATE) AS YEAR 
, COUNT (E.EXP_RECEIPTFK ) AS RCOUNTSpen
--, T.EXPCATTRAVEL_FROM
--, T.EXPCATTRAVEL_TO
, C.EXPCAT_NAME
, L.EXPCATLODGING_COMPANY
, E.EXP_AMOUNT

FROM "BRONZE_CE"."CE_PROD_01_DBO"."EXPCATLODGING" L
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EXP" E ON E.EXP_PK = L.EXPCATLODGING_EXPFK
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EXPCAT" C ON C.EXPCAT_PK = E.EXP_EXPCATFK


WHERE L._FIVETRAN_DELETED = FALSE AND E._FIVETRAN_DELETED = FALSE AND C._FIVETRAN_DELETED = FALSE
AND E.EXP_DATE>= $var_start_date and E.EXP_DATE<= $var_end_date
--AND C.EXPCAT_EXPTYPEFK IN (1,3)
AND LOWER(C.EXPCAT_NAME) LIKE '%lodging%' or LOWER(C.EXPCAT_NAME) LIKE '%hotel%'

GROUP BY MONTH,YEAR,L.EXPCATLODGING_COMPANY
, C.EXPCAT_NAME
, E.EXP_AMOUNT
--HAVING COUNT (E.EXP_RECEIPTFK ) >0
)
