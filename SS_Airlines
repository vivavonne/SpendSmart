SET VAR_START_DATE ='01-JAN-2019';
SET VAR_END_DATE = '30-SEP-2021';

(SELECT
 MONTHNAME(E.EXP_DATE) AS MONTH
, YEAR(E.EXP_DATE) AS YEAR 
, COUNT (E.EXP_RECEIPTFK ) AS RCOUNT
--, T.EXPCATTRAVEL_FROM
--, T.EXPCATTRAVEL_TO
, T.EXPCATTRAVEL_COMPANY
, E.EXP_AMOUNT

FROM "BRONZE_CE"."CE_PROD_01_DBO"."EXPCATTRAVEL" T
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EXP" E ON E.EXP_PK = T.EXPCATTRAVEL_EXPFK
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EXPCAT" C ON C.EXPCAT_PK = E.EXP_EXPCATFK


WHERE T._FIVETRAN_DELETED = FALSE AND E._FIVETRAN_DELETED = FALSE AND C._FIVETRAN_DELETED = FALSE
AND E.EXP_DATE>= $var_start_date and E.EXP_DATE<= $var_end_date
AND C.EXPCAT_EXPTYPEFK IN (1,6,9)
AND LOWER(C.EXPCAT_NAME) LIKE '%air%'
AND LOWER (EXPCATTRAVEL_COMPANY) LIKE '%united%'
or LOWER (EXPCATTRAVEL_COMPANY) LIKE '%american%'
or LOWER (EXPCATTRAVEL_COMPANY) LIKE '%delta%'
or LOWER (EXPCATTRAVEL_COMPANY) LIKE '%southwest%'
or LOWER (EXPCATTRAVEL_COMPANY) LIKE '%jet%'
or LOWER (EXPCATTRAVEL_COMPANY) LIKE '%blue%'
or LOWER (EXPCATTRAVEL_COMPANY) LIKE '%alaska%'
or LOWER (EXPCATTRAVEL_COMPANY) LIKE '%british%'
or LOWER (EXPCATTRAVEL_COMPANY) LIKE '%virgin%'

GROUP BY MONTH,YEAR,T.EXPCATTRAVEL_COMPANY
, C.EXPCAT_NAME
, E.EXP_AMOUNT
HAVING COUNT (E.EXP_RECEIPTFK ) >0
)

