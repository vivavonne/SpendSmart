SET VAR_START_DATE ='01-JAN-2019';
SET VAR_END_DATE = '30-SEP-2021';


CREATE OR REPLACE TABLE "JBML"."PUBLIC"."SS_TRANSPORT" AS
--SELECT  YEAR, VENDOR_NAME, AVG(TOTAL_AMT) FROM 
((SELECT
YEAR(A.EXPRPTAPPR_CREATEDATE) AS YEAR
, C.EXPCAT_NAME AS EXPENSE_CATEGORY
, E.EXP_VENDOR AS VENDOR_NAME
, COUNT (E.EXP_PK) AS REPORT_COUNT
, AVG (E.EXP_AMOUNT) AS TOTAL_AMT

FROM "BRONZE_CE"."CE_PROD_01_DBO"."EXP" E 
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EXPCAT" C ON C.EXPCAT_PK = E.EXP_EXPCATFK
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EXPRPT" R ON R.EXPRPT_EMPFK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_01_DBO"."EXPRPTAPPR" A ON A.EXPRPTAPPR_EXPRPTFK = R.EXPRPT_PK

WHERE E._FIVETRAN_DELETED = 'FALSE' AND C._FIVETRAN_DELETED = 'FALSE' AND R._FIVETRAN_DELETED = 'FALSE' AND A._FIVETRAN_DELETED = 'FALSE'
AND A.EXPRPTAPPR_CREATEDATE>= $var_start_date and A.EXPRPTAPPR_CREATEDATE<= $var_end_date
AND (LOWER(E.EXP_VENDOR) LIKE '%avis car%' 
OR LOWER(E.EXP_VENDOR) LIKE '%enterprise car%'
OR LOWER(E.EXP_VENDOR) LIKE '%hertz%'
OR LOWER(E.EXP_VENDOR) LIKE '%national car%'
OR LOWER(E.EXP_VENDOR) LIKE '%uber%'
OR LOWER(E.EXP_VENDOR) LIKE '%lyft%')
 
GROUP BY YEAR, C.EXPCAT_NAME, E.EXP_VENDOR
)

UNION ALL


(SELECT
YEAR(A.EXPRPTAPPR_CREATEDATE) AS YEAR
, C.EXPCAT_NAME AS EXPENSE_CATEGORY
, E.EXP_VENDOR AS VENDOR_NAME
, COUNT (E.EXP_PK) AS REPORT_COUNT
, AVG (E.EXP_AMOUNT) AS TOTAL_AMT

FROM "BRONZE_CE"."CE_PROD_02_DBO"."EXP" E 
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."EXPCAT" C ON C.EXPCAT_PK = E.EXP_EXPCATFK
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."EXPRPT" R ON R.EXPRPT_EMPFK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_02_DBO"."EXPRPTAPPR" A ON A.EXPRPTAPPR_EXPRPTFK = R.EXPRPT_PK

WHERE E._FIVETRAN_DELETED = 'FALSE' AND C._FIVETRAN_DELETED = 'FALSE' AND R._FIVETRAN_DELETED = 'FALSE' AND A._FIVETRAN_DELETED = 'FALSE'
AND A.EXPRPTAPPR_CREATEDATE>= $var_start_date and A.EXPRPTAPPR_CREATEDATE<= $var_end_date
AND (LOWER(E.EXP_VENDOR) LIKE '%avis car%' 
OR LOWER(E.EXP_VENDOR) LIKE '%enterprise car%'
OR LOWER(E.EXP_VENDOR) LIKE '%hertz%'
OR LOWER(E.EXP_VENDOR) LIKE '%national car%'
OR LOWER(E.EXP_VENDOR) LIKE '%uber%'
OR LOWER(E.EXP_VENDOR) LIKE '%lyft%')
 

GROUP BY YEAR, C.EXPCAT_NAME, E.EXP_VENDOR
)

UNION ALL


(SELECT
YEAR(A.EXPRPTAPPR_CREATEDATE) AS YEAR
, C.EXPCAT_NAME AS EXPENSE_CATEGORY
, E.EXP_VENDOR AS VENDOR_NAME
, COUNT (E.EXP_PK) AS REPORT_COUNT
, AVG (E.EXP_AMOUNT) AS TOTAL_AMT

FROM "BRONZE_CE"."CE_PROD_03_DBO"."EXP" E 
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."EXPCAT" C ON C.EXPCAT_PK = E.EXP_EXPCATFK
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."EXPRPT" R ON R.EXPRPT_EMPFK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_03_DBO"."EXPRPTAPPR" A ON A.EXPRPTAPPR_EXPRPTFK = R.EXPRPT_PK

WHERE E._FIVETRAN_DELETED = 'FALSE' AND C._FIVETRAN_DELETED = 'FALSE' AND R._FIVETRAN_DELETED = 'FALSE' AND A._FIVETRAN_DELETED = 'FALSE'
AND A.EXPRPTAPPR_CREATEDATE>= $var_start_date and A.EXPRPTAPPR_CREATEDATE<= $var_end_date
AND (LOWER(E.EXP_VENDOR) LIKE '%avis car%' 
OR LOWER(E.EXP_VENDOR) LIKE '%enterprise car%'
OR LOWER(E.EXP_VENDOR) LIKE '%hertz%'
OR LOWER(E.EXP_VENDOR) LIKE '%national car%'
OR LOWER(E.EXP_VENDOR) LIKE '%uber%'
OR LOWER(E.EXP_VENDOR) LIKE '%lyft%')
 
GROUP BY YEAR, C.EXPCAT_NAME, E.EXP_VENDOR
)

UNION ALL


(SELECT
YEAR(A.EXPRPTAPPR_CREATEDATE) AS YEAR
, C.EXPCAT_NAME AS EXPENSE_CATEGORY
, E.EXP_VENDOR AS VENDOR_NAME
, COUNT (E.EXP_PK) AS REPORT_COUNT
, AVG (E.EXP_AMOUNT) AS TOTAL_AMT

FROM "BRONZE_CE"."CE_PROD_04_DBO"."EXP" E 
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."EXPCAT" C ON C.EXPCAT_PK = E.EXP_EXPCATFK
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."EXPRPT" R ON R.EXPRPT_EMPFK = E.EXP_EMPFK
JOIN "BRONZE_CE"."CE_PROD_04_DBO"."EXPRPTAPPR" A ON A.EXPRPTAPPR_EXPRPTFK = R.EXPRPT_PK

WHERE E._FIVETRAN_DELETED = 'FALSE' AND C._FIVETRAN_DELETED = 'FALSE' AND R._FIVETRAN_DELETED = 'FALSE' AND A._FIVETRAN_DELETED = 'FALSE'
AND A.EXPRPTAPPR_CREATEDATE>= $var_start_date and A.EXPRPTAPPR_CREATEDATE<= $var_end_date
AND (LOWER(E.EXP_VENDOR) LIKE '%avis car%' 
OR LOWER(E.EXP_VENDOR) LIKE '%enterprise car%'
OR LOWER(E.EXP_VENDOR) LIKE '%hertz%'
OR LOWER(E.EXP_VENDOR) LIKE '%national car%'
OR LOWER(E.EXP_VENDOR) LIKE '%uber%'
OR LOWER(E.EXP_VENDOR) LIKE '%lyft%')
 

 
GROUP BY YEAR, C.EXPCAT_NAME, E.EXP_VENDOR
))

--GROUP BY YEAR, VENDOR_NAME, TOTAL_AMT
--ORDER BY YEAR
